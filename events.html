<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Events ‚Äî Event Finder</title>
    <meta name="description" content="Browse and search upcoming events in Nigeria." />
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="assets/css/main.css" />
  </head>
  <body>
    <header class="site-header">
      <nav class="nav" aria-label="Primary">
        <div class="nav__inner container">
          <span class="nav__logo" aria-label="Event Finder Home">EventFinder</span>
          <button class="nav__toggle" aria-controls="mobile-menu" aria-expanded="false">
            <span class="nav__toggle-icon" aria-hidden="true"></span>
            <span class="sr-only">Menu</span>
          </button>
          <ul id="primary-nav" class="nav__links" role="list">
            <li><a href="index.html">Home</a></li>
            <li><a href="events.html" aria-current="page">Events</a></li>
            <li><a href="about.html">About</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <!-- Mobile sidebar + backdrop -->
    <div class="sidebar-backdrop" hidden></div>
    <aside id="mobile-menu" class="sidebar" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-title" aria-hidden="true">
      <div class="sidebar__inner">
        <header class="sidebar__header">
          <h2 id="mobile-menu-title">Menu</h2>
          <button class="sidebar__close" aria-label="Close menu">&times;</button>
        </header>
        <nav class="sidebar__nav" aria-label="Mobile">
          <ul role="list">
            <li><a href="index.html">Home</a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="about.html">About</a></li>
          </ul>
        </nav>
      </div>
    </aside>

    <main id="main">
      

      <section class="find-create" aria-labelledby="layout-title">
        <div class="container sheet sheet--rounded">
          <h2 id="layout-title" class="sr-only">Find and Create Events</h2>
          <div class="page-grid">
            <!-- Left: Find Events -->
            <section class="panel glass-panel" aria-labelledby="search-title">
              <header class="panel__header">
                <h3 id="search-title" class="panel__title">Find Events</h3>
                <button type="button" id="scroll-create-top" class="button button--gradient button--glow panel__action">‚ûï Add Event</button>
              </header>
              <div class="panel__body">
                <form id="search-form" action="#" method="get" role="search" class="find-form">
                  <div class="search-large icon-input" data-icon="üîç">
                    <label class="sr-only" for="q">Search</label>
                    <input type="search" id="q" name="q" placeholder="Search events by name, keyword, or location‚Ä¶" autocomplete="off" />
                  </div>
                  <div class="filters filters--inline">
                    <button type="button" id="filters-toggle" class="filters__toggle soft-input icon-input" data-icon="üóÇÔ∏è" aria-expanded="false" aria-controls="filters-content">Advanced Filters</button>
                    <div class="filters__date icon-input soft-input" data-icon="üìÖ">
                      <label class="sr-only" for="date">Date</label>
                      <input type="date" id="date" name="date" />
                    </div>
                  </div>
                  <div id="filters-content" class="filters__content" hidden>
                    <div class="filters__row">
                      <div class="filters__field icon-input" data-icon="üé≠">
                        <label for="category">Category</label>
                        <select id="category" name="category">
                          <option value="">All categories</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="actions">
                    <button type="submit" class="button button--gradient button--glow">Search</button>
                    <button type="reset" class="button button--soft">Clear</button>
                    <button type="button" id="scroll-create" class="button button--ghost" title="Create a new event">‚ûï Add Event</button>
                  </div>
                </form>
              </div>
            </section>

            <!-- Right: Create New Event -->
            <section id="create-panel" class="panel glass-panel" aria-labelledby="create-title">
              <header class="panel__header">
                <h3 id="create-title" class="panel__title panel__title--accent">Create Name</h3>
              </header>
              <div class="panel__body">
                <div class="create-grid">
                  <form id="add-form" class="stack" novalidate>
                    <div class="float-label icon-input" data-icon="‚úèÔ∏è">
                      <input id="add-title-input" name="title" type="text" placeholder=" " required maxlength="200" />
                      <label for="add-title-input">Event Name</label>
                    </div>

                    <div class="float-label autosize">
                      <textarea id="add-description" name="description" placeholder=" " rows="3" maxlength="2000"></textarea>
                      <label for="add-description">Description (optional)</label>
                    </div>

                    <div class="icon-input" data-icon="üìç">
                      <label for="add-location">Location</label>
                      <input id="add-location" name="location" type="text" placeholder="City or venue" maxlength="200" />
                    </div>
                    <div class="switch-row">
                      <label class="switch">
                        <input type="checkbox" id="add-online" />
                        <span class="switch__slider" aria-hidden="true"></span>
                      </label>
                      <span class="switch__label">Online event</span>
                    </div>

                    <div class="form-row-two">
                      <div class="icon-input" data-icon="üìÖ">
                        <label for="add-start">Start (date &amp; time)</label>
                        <input id="add-start" name="start" type="datetime-local" required />
                      </div>
                      <div class="icon-input" data-icon="üìÖ">
                        <label for="add-end">End (optional)</label>
                        <input id="add-end" name="end" type="datetime-local" />
                      </div>
                    </div>

                    <div>
                      <label for="add-category">Category</label>
                      <select id="add-category" name="category" required>
                        <option value="">Select category</option>
                      </select>
                    </div>

                    <div class="upload-zone" id="upload-zone">
                      <input id="add-image" name="image" type="file" accept="image/*" aria-label="Upload image" />
                      <div class="upload-zone__content">
                        <span class="upload-zone__icon">üñºÔ∏è</span>
                        <p>Drag &amp; drop image here, or click to select</p>
                      </div>
                    </div>

                    <div class="panel__footer">
                      <button type="submit" class="button button--gradient button--glow">Save Event</button>
                      <button type="button" id="cancel-create" class="button button--outline-minimal">Cancel</button>
                    </div>
                  </form>

                  <aside class="preview-col">
                    <div class="event-preview">
                      <div class="event-preview__media" id="preview-media" aria-label="Preview image"></div>
                      <div class="event-preview__content">
                        <h3 id="preview-title">Event Title</h3>
                        <dl class="event-card__meta">
                          <div><dt>Date</dt><dd><time id="preview-date">TBD</time></dd></div>
                          <div><dt>Location</dt><dd id="preview-location">‚Äî</dd></div>
                          <div><dt>Category</dt><dd><span class="badge" id="preview-category">‚Äî</span></dd></div>
                        </dl>
                        <p class="event-card__desc" id="preview-desc">Description will appear here as you type.</p>
                      </div>
                    </div>
                  </aside>
                </div>
              </div>
            </section>
          </div>
        </div>
      </section>

      <!-- Results only on Events page -->

      <section class="events" aria-labelledby="results-title">
        <div class="events__inner container">
          <h2 id="results-title" class="section-title">All Results</h2>
          <div class="events__grid" id="events-grid"></div>
          <nav class="pagination" id="pagination" aria-label="Pagination">
            <button class="button button--secondary" id="prev-page" disabled>Previous</button>
            <span id="page-info"></span>
            <button class="button button--secondary" id="next-page">Next</button>
          </nav>
        </div>
      </section>
      <!-- Floating Add button for quick access (scrolls to create) -->
      <button id="fab-add" class="fab button button--gradient button--glow" title="Create a new event" aria-label="Create a new event">‚ûï</button>
    </main>

    <footer class="site-footer">
      <div class="site-footer__inner container">
        <p>&copy; <span id="year">2025</span> EventFinder. All rights reserved.</p>
        <ul class="site-footer__social" role="list" aria-label="Social media">
          <li><a href="#">Twitter</a></li>
          <li><a href="#">Facebook</a></li>
          <li><a href="#">Instagram</a></li>
          <li><a href="#">LinkedIn</a></li>
        </ul>
      </div>
    </footer>

    <script>
      (function () { var el = document.getElementById('year'); if (el) el.textContent = new Date().getFullYear(); })();
      (function () {
        var body = document.body;
        var toggle = document.querySelector('.nav__toggle');
        var sidebar = document.getElementById('mobile-menu');
        var closeBtn = document.querySelector('.sidebar__close');
        var backdrop = document.querySelector('.sidebar-backdrop');
        if (!toggle || !sidebar || !backdrop) return;
        function openSidebar() { body.setAttribute('data-sidebar', 'true'); toggle.setAttribute('aria-expanded', 'true'); sidebar.setAttribute('aria-hidden', 'false'); backdrop.hidden = false; }
        function closeSidebar() { body.removeAttribute('data-sidebar'); toggle.setAttribute('aria-expanded', 'false'); sidebar.setAttribute('aria-hidden', 'true'); backdrop.hidden = true; }
        toggle.addEventListener('click', function () { var isOpen = body.getAttribute('data-sidebar') === 'true'; if (isOpen) closeSidebar(); else openSidebar(); });
        if (closeBtn) closeBtn.addEventListener('click', closeSidebar);
        backdrop.addEventListener('click', closeSidebar);
        document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeSidebar(); });
      })();

      (function () {
        // API base (map localhost to 127.0.0.1)
        (function(){ var host = window.location.hostname; if (host === 'localhost') host = '127.0.0.1'; window.API_BASE = window.location.protocol + '//' + host + ':8001/api'; })();
        var API_BASE = window.API_BASE;

        var grid = document.getElementById('events-grid');
        var searchForm = document.getElementById('search-form');
        var catSelect = document.getElementById('category');
        var filtersToggle = document.getElementById('filters-toggle');
        var filtersContent = document.getElementById('filters-content');
        var fabAdd = document.getElementById('fab-add');
        var scrollCreateBtn = document.getElementById('scroll-create');
        var scrollCreateTop = document.getElementById('scroll-create-top');
        var addForm = document.getElementById('add-form');
        var isOnline = document.getElementById('add-online');
        var addLocation = document.getElementById('add-location');
        var addStart = document.getElementById('add-start');
        var addEnd = document.getElementById('add-end');
        var addCat = document.getElementById('add-category');
        var addTitle = document.getElementById('add-title-input');
        var addDesc = document.getElementById('add-description');
        var addImage = document.getElementById('add-image');
        var uploadZone = document.getElementById('upload-zone');
        // Preview elements
        var pTitle = document.getElementById('preview-title');
        var pDate = document.getElementById('preview-date');
        var pLoc = document.getElementById('preview-location');
        var pCat = document.getElementById('preview-category');
        var pDesc = document.getElementById('preview-desc');
        var pMedia = document.getElementById('preview-media');
        function escapeHtml(str) { return String(str || '').replace(/[&<>\"]/g, function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]);}); }
        function cardHTML(evt) {
          var dateText = new Date(evt.date).toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
          var catClass = 'badge';
          var cat = (evt.category || '').toLowerCase();
          if (cat === 'tech') catClass += ' badge--tech'; else if (cat === 'music') catClass += ' badge--music'; else if (cat === 'sports') catClass += ' badge--sports'; else if (cat === 'business') catClass += ' badge--business';
          return '<article class="event-card" aria-labelledby="ev-'+evt.id+'-title">\n'+
                 '  <header class="event-card__header"><h3 id="ev-'+evt.id+'-title" class="event-card__title">'+escapeHtml(evt.title)+'</h3></header>\n'+
                 '  <dl class="event-card__meta">\n'+
                 '    <div><dt>Date</dt><dd><time datetime="'+escapeHtml(evt.date)+'">'+dateText+'</time></dd></div>\n'+
                 '    <div><dt>Location</dt><dd>'+escapeHtml(evt.location)+'</dd></div>\n'+
                 '    <div><dt>Category</dt><dd><span class="'+catClass+'">'+escapeHtml(evt.category)+'</span></dd></div>\n'+
                 '  </dl>\n'+
                 '  <p class="event-card__desc">'+escapeHtml(evt.description||'')+'</p>\n'+
                 '  <p class="event-card__actions">\n'+
                 '    <a class="button button--ghost" href="event-detail.html?id='+evt.id+'">View Details</a>\n'+
                 '    <button class="button button--danger js-del" data-id="'+evt.id+'">Delete</button>\n'+
                 '  </p>\n'+
                 '</article>';
        }
        async function searchWithMeta(params){ var qs = new URLSearchParams(params).toString(); var res = await fetch(API_BASE + '/events?' + qs); if (!res.ok) throw new Error('Search failed'); var total = parseInt(res.headers.get('X-Total-Count')||'0',10); var items = await res.json(); return { items, total }; }
        function renderEvents(list){ if(!grid) return; if(!list || list.length===0){ grid.innerHTML = '<p>No events found.</p>'; return; } grid.innerHTML = list.map(cardHTML).join('');
          grid.querySelectorAll('.js-del').forEach(function(btn){ btn.addEventListener('click', async function(){ var id = btn.getAttribute('data-id'); if(!id) return; if(!confirm('Delete this event?')) return; try{ var res = await fetch(API_BASE + '/events/' + encodeURIComponent(id), { method: 'DELETE' }); if(res.status===204){ await runSearch(); } else { alert('Failed to delete event'); } } catch(e){ console.error(e); alert('Failed to delete event'); } }); });
        }
        var state = { limit: 12, offset: 0, total: 0, params: {} };
        var prevBtn = document.getElementById('prev-page');
        var nextBtn = document.getElementById('next-page');
        var pageInfo = document.getElementById('page-info');
        function updatePagination(){ var page=Math.floor(state.offset/state.limit)+1; var pages=Math.max(1,Math.ceil(state.total/state.limit)); if(pageInfo) pageInfo.textContent = 'Page '+page+' of '+pages; if(prevBtn) prevBtn.disabled = state.offset<=0; if(nextBtn) nextBtn.disabled = state.offset+state.limit>=state.total; }
        async function runSearch(){ var p=Object.assign({}, state.params, { limit: state.limit, offset: state.offset, sort: 'date_asc' }); var r = await searchWithMeta(p); state.total=r.total; renderEvents(r.items); updatePagination(); }
        if (searchForm){
          searchForm.addEventListener('submit', async function(e){
            e.preventDefault();
            var fd=new FormData(searchForm);
            var p={};
            fd.forEach((v,k)=>{ if(v) p[k]=v; });
            state.params = p;
            state.offset=0;
            await runSearch();
          });
          searchForm.addEventListener('reset', async function(){
            // Allow inputs to clear before searching again
            setTimeout(async function(){
              state.params = {};
              state.offset = 0;
              await runSearch();
            }, 0);
          });
        }
        // Smooth toggle for advanced filters and scroll to create
        if (filtersToggle && filtersContent){
          filtersToggle.addEventListener('click', function(){
            var open = filtersToggle.getAttribute('aria-expanded') === 'true';
            filtersToggle.setAttribute('aria-expanded', String(!open));
            if (open) { filtersContent.setAttribute('hidden',''); filtersContent.classList.remove('is-open'); }
            else { filtersContent.removeAttribute('hidden'); requestAnimationFrame(function(){ filtersContent.classList.add('is-open'); }); }
          });
        }
        function scrollToCreate(){ var el=document.getElementById('create-panel'); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); }
        if (fabAdd) fabAdd.addEventListener('click', scrollToCreate);
        if (scrollCreateBtn) scrollCreateBtn.addEventListener('click', scrollToCreate);
        if (scrollCreateTop) scrollCreateTop.addEventListener('click', scrollToCreate);

        if (isOnline && addLocation){
          var syncOnline = function(){ if(isOnline.checked){ addLocation.value = 'Online'; addLocation.setAttribute('disabled',''); } else { if(addLocation.value==='Online') addLocation.value=''; addLocation.removeAttribute('disabled'); } updatePreview(); };
          isOnline.addEventListener('change', syncOnline); syncOnline();
        }

        // Auto-resize description
        function autoResize(el){ el.style.height='auto'; el.style.height = Math.min(320, el.scrollHeight) + 'px'; }
        if (addDesc){ addDesc.addEventListener('input', function(){ autoResize(addDesc); updatePreview(); }); setTimeout(function(){ autoResize(addDesc); }, 0); }

        // Live preview updates
        function updatePreview(){
          var pTitle = document.getElementById('preview-title');
          var pDesc = document.getElementById('preview-desc');
          var pLoc = document.getElementById('preview-location');
          var pCat = document.getElementById('preview-category');
          var pDate = document.getElementById('preview-date');
          if (pTitle) pTitle.textContent = (addTitle && addTitle.value) ? addTitle.value : 'Event Title';
          if (pDesc) pDesc.textContent = (addDesc && addDesc.value) ? addDesc.value : 'Description will appear here as you type.';
          if (pLoc) pLoc.textContent = (isOnline && isOnline.checked) ? 'Online' : (addLocation && addLocation.value ? addLocation.value : '‚Äî');
          if (pCat) pCat.textContent = (addCat && addCat.value) ? (addCat.options[addCat.selectedIndex].text.replace(/^\S+\s/, '')) : '‚Äî';
          if (pDate) {
            var s = addStart && addStart.value ? new Date(addStart.value) : null;
            var e = addEnd && addEnd.value ? new Date(addEnd.value) : null;
            if (s && !isNaN(s)) {
              var opts = {year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'};
              var txt = s.toLocaleString(undefined, opts);
              if (e && !isNaN(e)) txt += ' ‚Äì ' + e.toLocaleString(undefined, opts);
              pDate.textContent = txt;
            } else { pDate.textContent = 'TBD'; }
          }
        }
        [addTitle, addDesc, addLocation, addStart, addEnd, addCat].forEach(function(el){ if(el) el.addEventListener('input', updatePreview); });

        // Upload preview + drag and drop
        if (document.getElementById('upload-zone') && document.getElementById('add-image')){
          var uploadZone = document.getElementById('upload-zone');
          var addImage = document.getElementById('add-image');
          var pMedia = document.getElementById('preview-media');
          function setPreview(file){
            if (!file) { if(pMedia){ pMedia.style.backgroundImage=''; pMedia.textContent=''; } return; }
            if (!/^image\//.test(file.type)) { alert('Please select a valid image file.'); return; }
            var reader = new FileReader();
            reader.onload = function(){ if(pMedia){ pMedia.style.backgroundImage = 'url(' + reader.result + ')'; pMedia.textContent=''; } };
            reader.readAsDataURL(file);
          }
          uploadZone.addEventListener('dragover', function(e){ e.preventDefault(); uploadZone.classList.add('is-drag'); });
          uploadZone.addEventListener('dragleave', function(){ uploadZone.classList.remove('is-drag'); });
          uploadZone.addEventListener('drop', function(e){ e.preventDefault(); uploadZone.classList.remove('is-drag'); var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]; if (f) { addImage.files = e.dataTransfer.files; setPreview(f); } });
          addImage.addEventListener('change', function(){ var f = addImage.files && addImage.files[0]; setPreview(f); });
        }

        if (addForm){
          addForm.addEventListener('submit', async function(e){
            e.preventDefault();
            // Basic client-side validation
            var title = (addTitle && addTitle.value.trim()) || '';
            var locationVal = (isOnline && isOnline.checked) ? 'Online' : ((addLocation && addLocation.value.trim()) || '');
            var startVal = addStart && addStart.value ? addStart.value : '';
            var categoryVal = addCat && addCat.value ? addCat.value : '';

            if (!title) { alert('Event name is required.'); addTitle && addTitle.focus(); return; }
            if (!startVal) { alert('Start date/time is required.'); addStart && addStart.focus(); return; }
            if (!locationVal) { alert('Location is required (or mark as Online).'); addLocation && addLocation.focus(); return; }
            if (!categoryVal) { alert('Please select a category.'); addCat && addCat.focus(); return; }

            // Map to API schema (date only; strip time)
            var dateOnly = new Date(startVal);
            if (isNaN(dateOnly)) { alert('Invalid date.'); addStart && addStart.focus(); return; }
            var yyyy = dateOnly.getFullYear();
            var mm = String(dateOnly.getMonth()+1).padStart(2,'0');
            var dd = String(dateOnly.getDate()).padStart(2,'0');
            var payload = {
              title: title,
              description: (addDesc && addDesc.value) || null,
              location: locationVal,
              category: categoryVal,
              date: yyyy + '-' + mm + '-' + dd
            };
            try {
              var res = await fetch(API_BASE + '/events/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              if (res.status === 201) {
                // Clear minimal fields for next use
                addForm.reset();
                state.offset = 0; await runSearch();
                updatePreview();
              } else {
                var txt = await res.text();
                alert('Failed to save event: ' + txt);
              }
            } catch (err) {
              console.error(err);
              alert('Could not reach the API. Is it running on port 8001?');
            }
          });
          var cancelBtn = document.getElementById('cancel-create');
          if (cancelBtn){
            cancelBtn.addEventListener('click', function(){ addForm.reset(); updatePreview(); });
          }
        }
        // No advanced filters panel in simplified UI
        if (prevBtn) prevBtn.addEventListener('click', async function(){ if(state.offset>0){ state.offset=Math.max(0,state.offset-state.limit); await runSearch(); window.scrollTo({top:0,behavior:'smooth'}); } });
        if (nextBtn) nextBtn.addEventListener('click', async function(){ if(state.offset+state.limit<state.total){ state.offset += state.limit; await runSearch(); window.scrollTo({top:0,behavior:'smooth'}); } });
        // Initial load
        (async function(){ try{ await runSearch(); } catch(_){} })();
        // Populate categories dynamically
        (async function(){
          try{
            if(!catSelect && !addCat) return;
            var res = await fetch(API_BASE + '/meta/categories');
            if(!res.ok) return;
            var cats = await res.json();
            var icons = { music:'üéµ', tech:'üíª', arts:'üé®', sports:'‚öΩ', business:'üíº', community:'üë•' };
            if (catSelect){
              var first = catSelect.querySelector('option');
              catSelect.innerHTML='';
              if(first) catSelect.appendChild(first);
              cats.forEach(function(c){ var o=document.createElement('option'); o.value=c; var label=c.charAt(0).toUpperCase()+c.slice(1); o.textContent=(icons[c] ? icons[c]+' ' : '') + label; catSelect.appendChild(o); });
            }
            if (addCat){
              var first2 = addCat.querySelector('option');
              addCat.innerHTML='';
              if(first2) addCat.appendChild(first2);
              cats.forEach(function(c){ var o2=document.createElement('option'); o2.value=c; var label2=c.charAt(0).toUpperCase()+c.slice(1); o2.textContent=(icons[c] ? icons[c]+' ' : '') + label2; addCat.appendChild(o2); });
            }
          } catch(_){}
        })();

        // (Location APIs removed by request: Google Maps/Places and Geolocation)
      })();
    </script>
  </body>
  </html>
