<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Events â€” Event Finder</title>
    <meta name="description" content="Browse and search upcoming events in Nigeria." />
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="assets/css/main.css" />
  </head>
  <body>
    <header class="site-header">
      <nav class="nav" aria-label="Primary">
        <div class="nav__inner container">
          <span class="nav__logo" aria-label="Event Finder Home">EventFinder</span>
          <button class="nav__toggle" aria-controls="mobile-menu" aria-expanded="false">
            <span class="nav__toggle-icon" aria-hidden="true"></span>
            <span class="sr-only">Menu</span>
          </button>
          <ul id="primary-nav" class="nav__links" role="list">
            <li><a href="index.html">Home</a></li>
            <li><a href="events.html" aria-current="page">Events</a></li>
            <li><a href="about.html">About</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <!-- Mobile sidebar + backdrop -->
    <div class="sidebar-backdrop" hidden></div>
    <aside id="mobile-menu" class="sidebar" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-title" aria-hidden="true">
      <div class="sidebar__inner">
        <header class="sidebar__header">
          <h2 id="mobile-menu-title">Menu</h2>
          <button class="sidebar__close" aria-label="Close menu">&times;</button>
        </header>
        <nav class="sidebar__nav" aria-label="Mobile">
          <ul role="list">
            <li><a href="index.html">Home</a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="about.html">About</a></li>
          </ul>
        </nav>
      </div>
    </aside>

    <main id="main">
      <section class="hero" aria-labelledby="hero-title">
        <div class="hero__inner container">
          <h1 id="hero-title">All Events</h1>
          <p class="hero__subtitle">Browse upcoming events.</p>
        </div>
      </section>

      <!-- Search & Filter (moved from Home) -->
      <section class="search" id="search" aria-labelledby="search-title">
        <div class="search__inner container">
          <h2 id="search-title">Search &amp; Filter</h2>
          <form class="search__form" id="search-form" action="#" method="get" role="search">
            <fieldset class="search__fieldset">
              <legend>Filter events</legend>

              <div class="form-row">
                <label for="q">Keyword</label>
                <input type="search" id="q" name="q" placeholder="e.g., tech, music, art" autocomplete="off" />
              </div>

              <div class="form-row">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" placeholder="City or venue" />
              </div>

              <div class="form-row">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" />
              </div>

              <div class="form-row">
                <label for="category">Category</label>
                <select id="category" name="category">
                  <option value="">All categories</option>
                  <option value="music">Music</option>
                  <option value="tech">Tech</option>
                  <option value="sports">Sports</option>
                  <option value="arts">Arts</option>
                  <option value="business">Business</option>
                  <option value="community">Community</option>
                </select>
              </div>

              <div class="form-actions">
                <button type="submit" class="button button--primary">Search</button>
                <button type="reset" class="button button--secondary">Clear</button>
              </div>
            </fieldset>
          </form>
        </div>
      </section>

      

      <!-- Results only on Events page -->

      <section class="events" aria-labelledby="results-title">
        <div class="events__inner container">
          <h2 id="results-title">All Results</h2>
          <div class="events__grid" id="events-grid"></div>
          <nav class="pagination" id="pagination" aria-label="Pagination">
            <button class="button button--secondary" id="prev-page" disabled>Previous</button>
            <span id="page-info"></span>
            <button class="button button--secondary" id="next-page">Next</button>
          </nav>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="site-footer__inner container">
        <p>&copy; <span id="year">2025</span> EventFinder. All rights reserved.</p>
        <ul class="site-footer__social" role="list" aria-label="Social media">
          <li><a href="#">Twitter</a></li>
          <li><a href="#">Facebook</a></li>
          <li><a href="#">Instagram</a></li>
          <li><a href="#">LinkedIn</a></li>
        </ul>
      </div>
    </footer>

    <script>
      (function () { var el = document.getElementById('year'); if (el) el.textContent = new Date().getFullYear(); })();
      (function () {
        var body = document.body;
        var toggle = document.querySelector('.nav__toggle');
        var sidebar = document.getElementById('mobile-menu');
        var closeBtn = document.querySelector('.sidebar__close');
        var backdrop = document.querySelector('.sidebar-backdrop');
        if (!toggle || !sidebar || !backdrop) return;
        function openSidebar() { body.setAttribute('data-sidebar', 'true'); toggle.setAttribute('aria-expanded', 'true'); sidebar.setAttribute('aria-hidden', 'false'); backdrop.hidden = false; }
        function closeSidebar() { body.removeAttribute('data-sidebar'); toggle.setAttribute('aria-expanded', 'false'); sidebar.setAttribute('aria-hidden', 'true'); backdrop.hidden = true; }
        toggle.addEventListener('click', function () { var isOpen = body.getAttribute('data-sidebar') === 'true'; if (isOpen) closeSidebar(); else openSidebar(); });
        if (closeBtn) closeBtn.addEventListener('click', closeSidebar);
        backdrop.addEventListener('click', closeSidebar);
        document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeSidebar(); });
      })();

      (function () {
        // API base (map localhost to 127.0.0.1)
        (function(){ var host = window.location.hostname; if (host === 'localhost') host = '127.0.0.1'; window.API_BASE = window.location.protocol + '//' + host + ':8001/api'; })();
        var API_BASE = window.API_BASE;

        var grid = document.getElementById('events-grid');
        var searchForm = document.getElementById('search-form');
        var catSelect = document.getElementById('category');
        function escapeHtml(str) { return String(str || '').replace(/[&<>\"]/g, function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]);}); }
        function cardHTML(evt) {
          var dateText = new Date(evt.date).toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
          var catClass = 'badge';
          var cat = (evt.category || '').toLowerCase();
          if (cat === 'tech') catClass += ' badge--tech'; else if (cat === 'music') catClass += ' badge--music'; else if (cat === 'sports') catClass += ' badge--sports'; else if (cat === 'business') catClass += ' badge--business';
          return '<article class="event-card" aria-labelledby="ev-'+evt.id+'-title">\n'+
                 '  <header class="event-card__header"><h3 id="ev-'+evt.id+'-title" class="event-card__title">'+escapeHtml(evt.title)+'</h3></header>\n'+
                 '  <dl class="event-card__meta">\n'+
                 '    <div><dt>Date</dt><dd><time datetime="'+escapeHtml(evt.date)+'">'+dateText+'</time></dd></div>\n'+
                 '    <div><dt>Location</dt><dd>'+escapeHtml(evt.location)+'</dd></div>\n'+
                 '    <div><dt>Category</dt><dd><span class="'+catClass+'">'+escapeHtml(evt.category)+'</span></dd></div>\n'+
                 '  </dl>\n'+
                 '  <p class="event-card__desc">'+escapeHtml(evt.description||'')+'</p>\n'+
                 '  <p class="event-card__actions">\n'+
                 '    <a class="button button--ghost" href="event-detail.html?id='+evt.id+'">View Details</a>\n'+
                 '    <button class="button button--danger js-del" data-id="'+evt.id+'">Delete</button>\n'+
                 '  </p>\n'+
                 '</article>';
        }
        async function searchWithMeta(params){ var qs = new URLSearchParams(params).toString(); var res = await fetch(API_BASE + '/events?' + qs); if (!res.ok) throw new Error('Search failed'); var total = parseInt(res.headers.get('X-Total-Count')||'0',10); var items = await res.json(); return { items, total }; }
        function renderEvents(list){ if(!grid) return; if(!list || list.length===0){ grid.innerHTML = '<p>No events found.</p>'; return; } grid.innerHTML = list.map(cardHTML).join('');
          grid.querySelectorAll('.js-del').forEach(function(btn){ btn.addEventListener('click', async function(){ var id = btn.getAttribute('data-id'); if(!id) return; if(!confirm('Delete this event?')) return; try{ var res = await fetch(API_BASE + '/events/' + encodeURIComponent(id), { method: 'DELETE' }); if(res.status===204){ await runSearch(); } else { alert('Failed to delete event'); } } catch(e){ console.error(e); alert('Failed to delete event'); } }); });
        }
        var state = { limit: 12, offset: 0, total: 0, params: {} };
        var prevBtn = document.getElementById('prev-page');
        var nextBtn = document.getElementById('next-page');
        var pageInfo = document.getElementById('page-info');
        function updatePagination(){ var page=Math.floor(state.offset/state.limit)+1; var pages=Math.max(1,Math.ceil(state.total/state.limit)); if(pageInfo) pageInfo.textContent = 'Page '+page+' of '+pages; if(prevBtn) prevBtn.disabled = state.offset<=0; if(nextBtn) nextBtn.disabled = state.offset+state.limit>=state.total; }
        async function runSearch(){ var p=Object.assign({}, state.params, { limit: state.limit, offset: state.offset, sort: 'date_asc' }); var r = await searchWithMeta(p); state.total=r.total; renderEvents(r.items); updatePagination(); }
        if (searchForm){ searchForm.addEventListener('submit', async function(e){ e.preventDefault(); var fd=new FormData(searchForm); var p={}; fd.forEach((v,k)=>{ if(v) p[k]=v; }); state.params = p; state.offset=0; await runSearch(); }); }
        if (prevBtn) prevBtn.addEventListener('click', async function(){ if(state.offset>0){ state.offset=Math.max(0,state.offset-state.limit); await runSearch(); window.scrollTo({top:0,behavior:'smooth'}); } });
        if (nextBtn) nextBtn.addEventListener('click', async function(){ if(state.offset+state.limit<state.total){ state.offset += state.limit; await runSearch(); window.scrollTo({top:0,behavior:'smooth'}); } });
        // Initial load
        (async function(){ try{ await runSearch(); } catch(_){} })();
        // Populate categories dynamically
        (async function(){ try{ if(!catSelect) return; var res = await fetch(API_BASE + '/meta/categories'); if(!res.ok) return; var cats = await res.json(); var first = catSelect.querySelector('option'); catSelect.innerHTML=''; if(first) catSelect.appendChild(first); cats.forEach(function(c){ var o=document.createElement('option'); o.value=c; o.textContent=c.charAt(0).toUpperCase()+c.slice(1); catSelect.appendChild(o); }); } catch(_){} })();

        // (Location APIs removed by request: Google Maps/Places and Geolocation)
      })();
    </script>
  </body>
  </html>
